# リファクタリング計画

## 目的
- 機能ごとの責務を明確にして読みやすくする
- 重複処理を減らして変更に強くする
- 初心者が追いやすい構成を維持する

## 現状の俯瞰（ファイル別）
- `js/main.js`：p5.js のライフサイクル、更新順序、カメラ、ドロップ更新などの統括
- `js/background.js`：背景演出（昼夜、星、雲）
- `js/input.js`：キーボード/マウス入力、設置/破壊/インタラクト
- `js/player.js`：プレイヤー移動と当たり判定
- `js/render.js`：描画処理（ブロック、プレイヤー、設置物、ドロップ）
- `js/particles.js`：パーティクル
- `js/state.js`：定数とゲーム状態、アイテム/ブロック定義
- `js/ui.js`：右カラムUI、チェスト/作業机のUIと操作
- `js/world.js`：ワールド生成、設置物管理、衝突判定

## 主な課題
- `GameState` が巨大で、責務ごとの境界が曖昧
- `input.js` と `ui.js` が長く、入出力とゲームロジックが混在
- `getToolSpriteIndex` など同名関数が複数ファイルに存在（重複）
- 数値のマジックナンバーが散在（速度、距離、サイズなど）
- 似た処理が各所に点在（座標変換、判定、配列探索）

## 方針
- 「状態」「描画」「入力」「ゲームロジック」を小さく分割する
- 共通ロジックはユーティリティとして集約する
- 定数は一箇所に集めて意味名を付ける

## 具体的ステップ（段階的）
### 1. 重複の整理（安全・低リスク）
- `getToolSpriteIndex` を `js/state.js` へ移動し共通関数化
- UIアイコン用のサイズ・間隔など定数を `js/state.js` か `js/ui.js` 上部に集約
- 画面座標変換（`screenToWorld`）などの共通ユーティリティを `js/main.js` から分離

### 2. 入力処理の分割（読みやすさ向上）
- `mousePressed` の左/右クリックを関数分割（例：`handleLeftClick` / `handleRightClick`）
- 「プレイヤー到達判定」「ブロック破壊」「設置判定」を独立関数化
- `tryToggleInteract` 周辺の処理を「インタラクト系」にまとめる

### 3. UI処理の分割（責務整理）
- 収納箱/作業机のUI生成と操作を `ui_chest.js` などに分離
- `updateSidebarUI` の内部処理を「描画用データ更新」と「DOM反映」に分ける
- Drag & Drop の共通ロジックをヘルパー化

### 4. 状態管理の整理（中リスク）
- `GameState` をカテゴリ別に整理（例：`playerState`, `worldState`, `uiState`）
- `placeables` 周りの操作を `world.js` 内の小さなAPIに集約

### 5. マジックナンバーの集約（保守性向上）
- 移動速度/重力/ジャンプ力/落下速度などを `js/state.js` の定数に集約
- UIのサイズ、パーティクル数なども同様に整理

## 期待される効果
- 変更点の影響範囲が明確になる
- 初心者が「どこを見れば良いか」迷いにくい
- 新機能追加（クラフト、敵、クエスト）時の拡張が容易
